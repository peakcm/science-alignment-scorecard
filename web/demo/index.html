<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Science Index — Autism Claim Prototype</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow-md p-5; }
    .badge { @apply inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold">Science Index <span class="text-slate-500">— Autism Claim Prototype</span></h1>
    <p class="text-sm text-slate-600 mt-1">Standalone demo. Data is embedded; no server required.</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 space-y-6">
    <!-- Topic & Consensus -->
    <section class="card">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-2xl font-semibold">Topic: Do vaccines cause autism?</h2>
          <p class="text-sm text-slate-600 mt-1">Evaluates whether a candidate promotes or rejects a causal link between routine vaccines/ingredients and autism.</p>
          <div class="mt-2 space-x-2">
            <span class="badge bg-emerald-100 text-emerald-800">Domain: Health</span>
            <span id="clarityBadge" class="badge bg-indigo-100 text-indigo-800">Consensus clarity: —</span>
          </div>
        </div>
        <div class="w-80">
          <canvas id="consensusChart" height="140"></canvas>
          <p class="text-[11px] text-slate-500 text-center mt-1">Consensus distribution (Dirichlet α normalized)</p>
        </div>
      </div>
      <div class="mt-4">
        <h3 class="font-semibold mb-1">Consensus summary</h3>
        <ul class="text-sm list-disc ml-5 text-slate-700">
          <li>Multiple high-certainty reviews (CDC/NASEM/Cochrane) find <span class="font-semibold">no causal link</span> between vaccines or their ingredients and autism.</li>
          <li class="mt-1">We represent consensus as a probability distribution over claim states and compute clarity via normalized entropy.</li>
        </ul>
      </div>
    </section>

    <!-- Candidate selector -->
    <section class="card">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Candidates</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">Select</label>
          <select id="candidateSelect" class="border rounded-md px-2 py-1 text-sm">
            <!-- options filled by JS -->
          </select>
        </div>
      </div>

      <div id="candidateGrid" class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-4">
        <!-- candidate cards injected here -->
      </div>
    </section>

    <!-- Evidence table -->
    <section class="card">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Evidence explorer</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">Filter by candidate</label>
          <select id="evidenceFilter" class="border rounded-md px-2 py-1 text-sm"></select>
        </div>
      </div>
      <div class="overflow-x-auto mt-3">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">Date</th>
              <th class="py-2 pr-4">Candidate</th>
              <th class="py-2 pr-4">Source</th>
              <th class="py-2 pr-4">Audience</th>
              <th class="py-2 pr-4">Excerpt</th>
              <th class="py-2 pr-4">Mapped stance</th>
              <th class="py-2">Weight</th>
            </tr>
          </thead>
          <tbody id="evidenceBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-8 text-xs text-slate-500">
    <p>Prototype UI — Methods: overlap = sum(min(p_consensus, p_stance)). Waffling is illustrative.</p>
  </footer>

<script>
// ---------------- Seed data (mirrors earlier JSON:API seeds) ----------------
const claimSpace = {
  id: "b2d9e5a1-8a3c-4b0c-9e9a-1a6c6d3b2c10",
  name: "Autism Causation Claim",
  measurement_type: "categorical",
  states: [
    {id:"causal", label:"Causal link exists", polarity:"counter", order:0},
    {id:"no_link", label:"No causal link", polarity:"consensus", order:1},
    {id:"uncertain", label:"Uncertain/agnostic", polarity:"neutral", order:2}
  ]
};

const topic = {
  id: "4f3f7b8d-5a7a-4f66-b6ea-6c0a2e3f3a77",
  name: "Do vaccines cause autism?",
  domain: "health",
  description: "Evaluates whether a candidate promotes or rejects a causal link between routine vaccines or their ingredients and autism."
};

const consensusPrior = {
  id: "c7ad3e7a-9a04-49d3-a8d0-04f1d3b0a501",
  as_of: "2025-01-15",
  dirichlet_alpha: [1, 700, 3],
  consensus_clarity: 0.96,
  sources: [
    {type:"ACIP", title:"ACIP Safety Overview", url:"#"},
    {type:"NASEM", title:"No association with autism", url:"#"},
    {type:"Cochrane", title:"MMR safety review", url:"#"}
  ]
};

const candidates = [
  { id:"cand-a", name:"Candidate A", cycle:"2024" },
  { id:"cand-b", name:"Candidate B", cycle:"2024" }
];

const stanceEstimates = [
  { id:"stance-555", candidate_id:"cand-a", topic_id:topic.id, window_start:"2024-06-01", window_end:"2025-06-01",
    dirichlet_beta:[0.5,2.8,0.7], probabilities:[0.12,0.70,0.18], n_units:7, data_sufficiency:"adequate" },
  { id:"stance-556", candidate_id:"cand-b", topic_id:topic.id, window_start:"2024-06-01", window_end:"2025-06-01",
    dirichlet_beta:[1.2,1.0,1.0], probabilities:[0.40,0.33,0.27], n_units:5, data_sufficiency:"low" }
];

const scoreSnapshots = [
  { candidate_id:"cand-a", topic_id:topic.id, as_of:"2025-08-13", alignment_score:88.0, ci_low:80.5, ci_high:92.7, consensus_clarity:0.96, waffling_score:22.0 },
  { candidate_id:"cand-b", topic_id:topic.id, as_of:"2025-08-13", alignment_score:46.0, ci_low:34.0, ci_high:58.0, consensus_clarity:0.96, waffling_score:41.0 }
];

const evidenceUnits = [
  { candidate_id:"cand-a", date:"2025-03-10", source_type:"interview", audience_type:"national_media", venue:"Network Interview", source_url:"#",
    extracted_text:"Vaccines do not cause autism.", stance_state_id:"no_link", effective_weight:0.75 },
  { candidate_id:"cand-a", date:"2025-02-15", source_type:"rally_remark", audience_type:"party_base", venue:"Campaign Rally", source_url:"#",
    extracted_text:"Some parents remain unsure about vaccines; we should listen to them.", stance_state_id:"uncertain", effective_weight:0.26 },
  { candidate_id:"cand-b", date:"2025-04-18", source_type:"social_post", audience_type:"online_followers", venue:"Social Platform", source_url:"#",
    extracted_text:"We should investigate vaccines and autism further.", stance_state_id:"uncertain", effective_weight:0.20 },
  { candidate_id:"cand-b", date:"2025-01-05", source_type:"interview", audience_type:"local_media", venue:"Local Radio", source_url:"#",
    extracted_text:"Some vaccines may be linked to autism.", stance_state_id:"causal", effective_weight:0.38 }
];

// ---------------- Helpers ----------------
function normalizeAlpha(alpha) {
  const sum = alpha.reduce((a,b)=>a+b,0);
  return alpha.map(a => a/sum);
}
function overlap(p, q) {
  return 100 * p.map((pi,i)=>Math.min(pi, q[i])).reduce((a,b)=>a+b,0);
}
function pct(x) { return (x*100).toFixed(1) + "%"; }
function prettyState(id) {
  return claimSpace.states.find(s=>s.id===id)?.label || id;
}

// ---------------- Render Consensus ----------------
const consensusP = normalizeAlpha(consensusPrior.dirichlet_alpha);
document.getElementById("clarityBadge").textContent = `Consensus clarity: ${(consensusPrior.consensus_clarity*100).toFixed(0)}%`;

const ctxC = document.getElementById('consensusChart').getContext('2d');
new Chart(ctxC, {
  type: 'bar',
  data: {
    labels: claimSpace.states.map(s=>s.label),
    datasets: [{
      label: 'Consensus probability',
      data: consensusP.map(v => (v*100).toFixed(1))
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => ctx.parsed.y + '%' } }
    },
    scales: {
      y: { ticks: { callback: v => v + '%' }, suggestedMax: 100 }
    }
  }
});

// ---------------- Render Candidates ----------------
const candidateSelect = document.getElementById('candidateSelect');
const evidenceFilter = document.getElementById('evidenceFilter');
[candidateSelect, evidenceFilter].forEach(sel => {
  candidates.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.name;
    sel.appendChild(opt.cloneNode(true));
  });
  const all = document.createElement('option');
  all.value = "all"; all.textContent = "All candidates";
  sel.insertBefore(all, sel.firstChild);
  sel.value = "all";
});

function cardForCandidate(cand) {
  const stance = stanceEstimates.find(s => s.candidate_id === cand.id);
  const score = scoreSnapshots.find(s => s.candidate_id === cand.id);
  const p = stance ? stance.probabilities : [0,0,0];
  const ov = overlap(consensusP, p).toFixed(1);
  const badgeColor = (val)=> val>=85 ? 'bg-emerald-100 text-emerald-800' : val>=60 ? 'bg-amber-100 text-amber-800' : 'bg-rose-100 text-rose-800';

  return `
  <div class="border rounded-2xl p-4 bg-white">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h4 class="text-lg font-semibold">${cand.name}</h4>
        <div class="mt-1 space-x-2">
          <span class="badge ${badgeColor(score?.alignment_score ?? ov)}">Alignment: ${(score?.alignment_score ?? ov)}%</span>
          <span class="badge bg-slate-100 text-slate-800">Waffling: ${(score?.waffling_score ?? 0).toFixed(0)}</span>
        </div>
        ${score ? `<p class="text-xs text-slate-500 mt-1">CI: ${score.ci_low.toFixed(1)}–${score.ci_high.toFixed(1)}</p>` : ''}
      </div>
      <div class="w-64">
        <canvas id="chart-${cand.id}" height="120"></canvas>
        <p class="text-[11px] text-slate-500 text-center mt-1">Stance vs Consensus</p>
      </div>
    </div>
    <div class="mt-2 text-xs text-slate-600">
      <span class="font-medium">Evidence units:</span> ${stance?.n_units ?? 0} | Data sufficiency: ${stance?.data_sufficiency ?? 'insufficient'}
    </div>
  </div>`;
}

function renderCandidates() {
  const grid = document.getElementById('candidateGrid');
  grid.innerHTML = '';
  const selected = candidateSelect.value;
  const list = selected==='all' ? candidates : candidates.filter(c => c.id === selected);
  list.forEach(c => grid.insertAdjacentHTML('beforeend', cardForCandidate(c)));
  // draw charts
  list.forEach(c => {
    const ctx = document.getElementById(`chart-${c.id}`).getContext('2d');
    const stance = stanceEstimates.find(s => s.candidate_id === c.id);
    const p = stance ? stance.probabilities.map(x=> (x*100).toFixed(1)) : [0,0,0];
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: claimSpace.states.map(s=>s.label),
        datasets: [
          { label: 'Consensus', data: consensusP.map(v => (v*100).toFixed(1)) },
          { label: 'Stance', data: p }
        ]
      },
      options: {
        responsive: true,
        plugins: { tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + '%' } } },
        scales: { y: { ticks: { callback: v => v + '%' }, suggestedMax: 100 } }
      }
    });
  });
}

candidateSelect.addEventListener('change', renderCandidates);
renderCandidates();

// ---------------- Evidence table ----------------
function renderEvidence() {
  const tbody = document.getElementById('evidenceBody');
  tbody.innerHTML = '';
  const filt = evidenceFilter.value;
  const rows = filt && filt!=="all" ? evidenceUnits.filter(e => e.candidate_id === filt) : evidenceUnits;
  rows.sort((a,b) => (a.date > b.date ? -1 : 1)).forEach(e => {
    const candName = candidates.find(c=>c.id===e.candidate_id)?.name || e.candidate_id;
    const tr = document.createElement('tr');
    tr.className = "border-b";
    tr.innerHTML = `
      <td class="py-2 pr-4 whitespace-nowrap">${e.date}</td>
      <td class="py-2 pr-4">${candName}</td>
      <td class="py-2 pr-4">${e.source_type.replace('_',' ')}</td>
      <td class="py-2 pr-4">${e.audience_type.replace('_',' ')}</td>
      <td class="py-2 pr-4 max-w-[420px]">${e.extracted_text}</td>
      <td class="py-2 pr-4">${prettyState(e.stance_state_id)}</td>
      <td class="py-2">${e.effective_weight.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}
evidenceFilter.addEventListener('change', renderEvidence);
renderEvidence();

</script>
</body>
</html>
