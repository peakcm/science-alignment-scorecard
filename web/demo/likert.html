<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Science Index — Likert Prototype (Autism Claim)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold">Science Index <span class="text-slate-500">— Likert Prototype</span></h1>
    <p class="text-sm text-slate-600 mt-1">Autism claim: “Vaccines cause autism.” Axis = Strongly disagree ⟶ Uncertain ⟶ Strongly agree.</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 space-y-6">
    <!-- Topic & Consensus (Likert prior) -->
    <section class="bg-white rounded-2xl shadow p-5">
      <div class="flex items-start justify-between gap-4">
        <div class="flex-1">
          <h2 class="text-2xl font-semibold">Topic: Do vaccines cause autism?</h2>
          <p class="text-sm text-slate-600 mt-1">
            We treat the proposition "<span class="italic">vaccines cause autism</span>" as the Likert statement.
            Consensus prior comes from a weighted mixture over states: <span class="font-medium">No causal link</span> (−2),
            <span class="font-medium">Uncertain</span> (0), <span class="font-medium">Causal link</span> (+2).
          </p>
          <div class="mt-2 space-x-2">
            <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-emerald-100 text-emerald-800">Domain: Health</span>
            <span id="clarityBadge" class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">Consensus clarity: —</span>
          </div>
        </div>
        <div class="w-full md:w-[480px]">
          <canvas id="priorChart" height="160"></canvas>
          <p class="text-[11px] text-slate-500 text-center mt-1">Scientific consensus prior (smoothed density)</p>
        </div>
      </div>
    </section>

    <!-- Candidates -->
    <section class="bg-white rounded-2xl shadow p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Candidates</h3>
        <div class="flex items-center gap-3">
          <label class="text-sm">Select</label>
          <select id="candidateSelect" class="border rounded-md px-2 py-1 text-sm"></select>
          <label class="text-sm">Bandwidth</label>
          <input id="bandwidth" type="range" min="0.15" max="0.8" step="0.05" value="0.35">
          <span id="bwLabel" class="text-xs text-slate-600">0.35</span>
        </div>
      </div>

      <div id="candidateGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <!-- candidate cards injected here -->
      </div>
    </section>

    <!-- Evidence table -->
    <section class="bg-white rounded-2xl shadow p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Evidence explorer</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">Filter by candidate</label>
          <select id="evidenceFilter" class="border rounded-md px-2 py-1 text-sm"></select>
        </div>
      </div>
      <div class="overflow-x-auto mt-3">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">Date</th>
              <th class="py-2 pr-4">Candidate</th>
              <th class="py-2 pr-4">Source</th>
              <th class="py-2 pr-4">Audience</th>
              <th class="py-2 pr-4">Excerpt</th>
              <th class="py-2 pr-4">Mapped stance</th>
              <th class="py-2">Weight</th>
            </tr>
          </thead>
          <tbody id="evidenceBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-8 text-xs text-slate-500">
    <p>Overlap scoring shown on cards; Likert = −2 (Strongly disagree) … 0 (Uncertain) … +2 (Strongly agree).</p>
  </footer>

<script>
// ---------------- Seed data ----------------
const claimSpace = {
  states: [
    {id:"causal", label:"Causal link exists", polarity:"counter", order:2},   // +2 (agree with proposition)
    {id:"no_link", label:"No causal link", polarity:"consensus", order:-2},   // -2 (strongly disagree)
    {id:"uncertain", label:"Uncertain/agnostic", polarity:"neutral", order:0} // 0
  ]
};

const topic = { id: "4f3f7b8d-5a7a-4f66-b6ea-6c0a2e3f3a77", name:"Do vaccines cause autism?" };

const consensusPrior = {
  dirichlet_alpha: [1, 700, 3], // [causal, no_link, uncertain]
  consensus_clarity: 0.96
};

const candidates = [
  { id:"cand-a", name:"Candidate A", cycle:"2024" },
  { id:"cand-b", name:"Candidate B", cycle:"2024" }
];

const stanceEstimates = [
  { candidate_id:"cand-a", probabilities:[0.12,0.70,0.18], n_units:7, data_sufficiency:"adequate", ci:[80.5,92.7], alignment:88.0, waffling:22.0 },
  { candidate_id:"cand-b", probabilities:[0.40,0.33,0.27], n_units:5, data_sufficiency:"low", ci:[34.0,58.0], alignment:46.0, waffling:41.0 }
];

const evidenceUnits = [
  { candidate_id:"cand-a", date:"2025-03-10", source_type:"interview", audience_type:"national_media", venue:"Network Interview", source_url:"#",
    extracted_text:"Vaccines do not cause autism.", stance_state_id:"no_link", effective_weight:0.75 },
  { candidate_id:"cand-a", date:"2025-02-15", source_type:"rally_remark", audience_type:"party_base", venue:"Campaign Rally", source_url:"#",
    extracted_text:"Some parents remain unsure about vaccines; we should listen to them.", stance_state_id:"uncertain", effective_weight:0.26 },
  { candidate_id:"cand-b", date:"2025-04-18", source_type:"social_post", audience_type:"online_followers", venue:"Social Platform", source_url:"#",
    extracted_text:"We should investigate vaccines and autism further.", stance_state_id:"uncertain", effective_weight:0.20 },
  { candidate_id:"cand-b", date:"2025-01-05", source_type:"interview", audience_type:"local_media", venue:"Local Radio", source_url:"#",
    extracted_text:"Some vaccines may be linked to autism.", stance_state_id:"causal", effective_weight:0.38 }
];

// ---------------- Likert axis ----------------
const LIKERT_MIN = -2, LIKERT_MAX = 2;
const TICKS = [
  {x:-2, label:"Strongly disagree"},
  {x:-1, label:"Disagree"},
  {x: 0, label:"Uncertain"},
  {x: 1, label:"Agree"},
  {x: 2, label:"Strongly agree"}
];

function stateToX(stateId){
  if(stateId === "no_link") return -2;
  if(stateId === "uncertain") return 0;
  if(stateId === "causal") return 2;
  return 0;
}
function normalizeAlpha(alpha){
  const s = alpha.reduce((a,b)=>a+b,0);
  return alpha.map(v => v/s);
}

// KDE utilities
function gaussian(x, h){ const z=x/h; return Math.exp(-0.5*z*z)/(Math.sqrt(2*Math.PI)*h); }
function kde(xs, points, weights, h){
  return xs.map(x => points.reduce((acc, xi, i) => acc + weights[i]*gaussian(x - xi, h), 0));
}
function grid(n=201){
  const arr = [];
  for(let i=0;i<n;i++){
    arr.push(LIKERT_MIN + i*(LIKERT_MAX-LIKERT_MIN)/(n-1));
  }
  return arr;
}
function normalizeDensity(xs, ys){
  // simple Riemann sum to 1.0
  const dx = (LIKERT_MAX-LIKERT_MIN)/(xs.length-1);
  const area = ys.reduce((a,b)=>a+b,0)*dx;
  return area>0 ? ys.map(y=>y/area) : ys;
}

// Consensus prior as mixture over {-2,0,2}
function priorDensity(xs, alpha, h=0.35){
  const p = normalizeAlpha(alpha);
  const centers = [2, -2, 0]; // careful: alpha order is [causal, no_link, uncertain]
  // align probabilities accordingly
  const probs = [p[0], p[1], p[2]];
  const ys = xs.map(x => probs[0]*gaussian(x-centers[0], h) + probs[1]*gaussian(x-centers[1], h) + probs[2]*gaussian(x-centers[2], h));
  return normalizeDensity(xs, ys);
}

// Build consensus chart
document.getElementById("clarityBadge").textContent = `Consensus clarity: ${(consensusPrior.consensus_clarity*100).toFixed(0)}%`;
const xs = grid();
const priorYs = priorDensity(xs, consensusPrior.dirichlet_alpha, 0.35);
const priorCtx = document.getElementById("priorChart").getContext("2d");
new Chart(priorCtx, {
  type: 'line',
  data: {
    labels: xs,
    datasets: [{
      label: "Scientific consensus (prior)",
      data: priorYs,
      fill: true,
      pointRadius: 0,
      tension: 0.25
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: (ctx)=> `Density: ${ctx.parsed.y.toFixed(3)}` } }
    },
    scales: {
      x: {
        type: 'linear',
        min: LIKERT_MIN, max: LIKERT_MAX,
        ticks: {
          callback: function(value){ const t=TICKS.find(t=>t.x===value); return t? t.label : ''; },
          stepSize: 1
        }
      },
      y: {
        title: { display: true, text: "Density" },
        beginAtZero: true
      }
    }
  }
});

// Candidate cards with Likert density + points
const candidateSelect = document.getElementById('candidateSelect');
const evidenceFilter = document.getElementById('evidenceFilter');
[candidateSelect, evidenceFilter].forEach(sel => {
  const all = document.createElement('option'); all.value = "all"; all.textContent = "All candidates";
  sel.appendChild(all);
  candidates.forEach(c => { const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.name; sel.appendChild(opt); });
  sel.value = "all";
});

const bwSlider = document.getElementById('bandwidth');
const bwLabel = document.getElementById('bwLabel');
bwSlider.addEventListener('input', () => { bwLabel.textContent = (+bwSlider.value).toFixed(2); renderCandidates(); });

function badgeColor(val){
  if(val>=85) return 'bg-emerald-100 text-emerald-800';
  if(val>=60) return 'bg-amber-100 text-amber-800';
  return 'bg-rose-100 text-rose-800';
}

function cardForCandidate(cand){
  const meta = stanceEstimates.find(s=>s.candidate_id===cand.id);
  const align = meta?.alignment ?? 0;
  const waff = meta?.waffling ?? 0;
  const ci = meta?.ci ?? null;

  const evidence = evidenceUnits.filter(e=>e.candidate_id===cand.id);
  const points = evidence.map(e=> stateToX(e.stance_state_id));
  const weights = evidence.map(e=> e.effective_weight ?? 0.2);
  const h = +bwSlider.value;
  const ys = normalizeDensity(xs, kde(xs, points, weights, h));

  // Build scatter "rug" along baseline (y≈0)
  const scatter = evidence.map(e => ({
    x: stateToX(e.stance_state_id),
    y: 0,
    _meta: e
  }));

  const canvasId = `likert-${cand.id}`;
  return `
  <div class="border rounded-2xl p-4 bg-white">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h4 class="text-lg font-semibold">${cand.name}</h4>
        <div class="mt-1 space-x-2">
          <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${badgeColor(align)}">Alignment: ${align.toFixed(1)}%</span>
          <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-800">Waffling: ${waff.toFixed(0)}</span>
        </div>
        ${ci ? `<p class="text-xs text-slate-500 mt-1">CI: ${ci[0].toFixed(1)}–${ci[1].toFixed(1)}</p>` : ''}
      </div>
      <div class="w-full md:w-[480px]">
        <canvas id="${canvasId}" height="180"></canvas>
        <p class="text-[11px] text-slate-500 text-center mt-1">Candidate density (line), statements (points) & prior (dashed)</p>
      </div>
    </div>
    <div class="mt-2 text-xs text-slate-600">
      <span class="font-medium">Evidence units:</span> ${meta?.n_units ?? evidence.length} | Data sufficiency: ${meta?.data_sufficiency ?? 'insufficient'}
    </div>
  </div>`;
}

function renderCandidates(){
  const grid = document.getElementById('candidateGrid');
  grid.innerHTML = '';
  const selected = candidateSelect.value;
  const list = selected==='all' ? candidates : candidates.filter(c=>c.id===selected);
  list.forEach(c => {
    grid.insertAdjacentHTML('beforeend', cardForCandidate(c));
  });

  // Draw charts for each
  list.forEach(c => {
    const meta = stanceEstimates.find(s=>s.candidate_id===c.id);
    const evidence = evidenceUnits.filter(e=>e.candidate_id===c.id);
    const points = evidence.map(e=> stateToX(e.stance_state_id));
    const weights = evidence.map(e=> e.effective_weight ?? 0.2);
    const h = +bwSlider.value;
    const candYs = normalizeDensity(xs, kde(xs, points, weights, h));
    const scatter = evidence.map(e => ({ x: stateToX(e.stance_state_id), y: 0, _meta: e }));

    const ctx = document.getElementById(`likert-${c.id}`).getContext('2d');
    new Chart(ctx, {
      data: {
        labels: xs,
        datasets: [
          {
            type: 'line',
            label: `${c.name} (smoothed)`,
            data: candYs,
            fill: true,
            pointRadius: 0,
            tension: 0.25
          },
          {
            type: 'line',
            label: 'Scientific consensus (prior)',
            data: priorYs,
            pointRadius: 0,
            fill: false,
            borderDash: [6,4],
            tension: 0.25
          },
          {
            type: 'scatter',
            label: 'Statements',
            data: scatter,
            pointRadius: 4
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              title: (items) => {
                const it = items[0];
                const x = it.parsed.x;
                const t = (x<=-1.5) ? "Strongly disagree" :
                          (x<-0.5) ? "Disagree" :
                          (x<0.5) ? "Uncertain" :
                          (x<1.5) ? "Agree" : "Strongly agree";
                return `Likert: ${t}`;
              },
              label: (ctx) => {
                if(ctx.dataset.type === 'scatter'){
                  const e = ctx.raw._meta;
                  return `${e.date} • ${e.source_type} • ${e.audience_type}\n“${e.extracted_text}”`;
                } else {
                  return `Density: ${ctx.parsed.y.toFixed(3)}`;
                }
              }
            }
          },
          legend: { display: true }
        },
        scales: {
          x: {
            type: 'linear',
            min: LIKERT_MIN, max: LIKERT_MAX,
            ticks: {
              stepSize: 1,
              callback: function(val){
                const t = TICKS.find(t=>t.x===val);
                return t ? t.label : '';
              }
            }
          },
          y: {
            title: { display: true, text: "Density" },
            beginAtZero: true
          }
        }
      }
    });
  });
}

candidateSelect.addEventListener('change', renderCandidates);
renderCandidates();

// Evidence table
const evidenceBody = document.getElementById('evidenceBody');
function prettyState(id){
  const s = claimSpace.states.find(s=>s.id===id);
  if(id==='no_link') return 'Strongly disagree';
  if(id==='uncertain') return 'Uncertain';
  if(id==='causal') return 'Strongly agree';
  return s?.label || id;
}
function renderEvidence(){
  evidenceBody.innerHTML = '';
  const filt = evidenceFilter.value;
  const rows = (filt && filt!=="all") ? evidenceUnits.filter(e=>e.candidate_id===filt) : evidenceUnits;
  const name = id => (candidates.find(c=>c.id===id)?.name || id);
  rows.sort((a,b)=> (a.date > b.date ? -1 : 1)).forEach(e => {
    const tr = document.createElement('tr');
    tr.className = "border-b";
    tr.innerHTML = `
      <td class="py-2 pr-4 whitespace-nowrap">${e.date}</td>
      <td class="py-2 pr-4">${name(e.candidate_id)}</td>
      <td class="py-2 pr-4">${e.source_type.replace('_',' ')}</td>
      <td class="py-2 pr-4">${e.audience_type.replace('_',' ')}</td>
      <td class="py-2 pr-4 max-w-[420px]">${e.extracted_text}</td>
      <td class="py-2 pr-4">${prettyState(e.stance_state_id)}</td>
      <td class="py-2">${(e.effective_weight ?? 0.2).toFixed(2)}</td>
    `;
    evidenceBody.appendChild(tr);
  });
}
evidenceFilter.addEventListener('change', renderEvidence);
renderEvidence();
</script>
</body>
</html>
